name: ‚≠ê Update here-be-stars
on:
  push:
  workflow_dispatch:
  schedule:
    - cron: 30 0 * * *

jobs:
  delete_old_runs:
    name: üßπ Delete old workflow runs
    runs-on: ubuntu-latest

    steps:
      - name: üßπ Delete old workflow runs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api repos/${{ github.repository }}/actions/runs \
          --paginate -q '.workflow_runs[] | select(.status != "in_progress" and .status != "queued") | "\(.id)"' | \
          xargs -n1 -I % gh api repos/${{ github.repository }}/actions/runs/% -X DELETE
  update-stars:
    name: ‚≠ê Update the stars repo
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.7']
        
    steps:
      - name: ‚¨á Checkout
        uses: actions/checkout@v3

      - name: üîß Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v3
        with:
          python-version: ${{ matrix.python-version }}

      - name: üîß Install dependencies
        run: |
          python -m pip install --upgrade pip wheel
          python -m pip install setuptools
          pip install -e git+https://github.com/arbal/starred@master#egg=starred

      - name: üîß Checks
        run: |
          pip -V
          pip show starred

      - name: ‚≠ê Update stars README
        env:
          GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}
          GITHUB_REPOSITORY_NAME: ${{ github.event.repository.name }}
          ACCESS_TOKEN: ${{ secrets.ACCESS_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          starred --username ${GITHUB_REPOSITORY_OWNER} --repository ${REPO_NAME} --sort
          git add .
          git config user.name "Github Actions"
          git config user.email "actions@github.com"
          git commit -am "‚≠ê Github Stars update [Github Actions Cron]"
          git push origin
        
#       - name: Push changes
#         uses: actions-go/push@master
#         with:
#           remote: origin
#           commit-message: "‚≠ê Github Stars update [Github Actions Cron]"
